name: Run tests

# Триггер
on: [ push, workflow_dispatch ]

jobs: # аналог этапов
  run-tests:
    name: Set up services (review apps) and run API and UI tests
    runs-on: ubuntu-latest
    steps: # Шаги конкретной job
      - name: Checkout repository # Копируем файлы репо внутрь CI агента
        uses: actions/checkout@v4

      - name: Debug - List files
        run: |
          echo "Current directory:"
          pwd
          echo ""
          echo "Files in current directory:"
          ls -la
          echo ""
          echo "Files in infrastructure:"
          ls -la infrastructure/
          echo ""
          echo "Files in infrastructure/config:"
          ls -la infrastructure/config/
          echo ""
          echo "Tree structure:"
          tree -L 3 || find . -maxdepth 3 -print
          echo "Ищем config.properties:"
          ls -la resources

      - name: Check container status
        if: always()
        run: |
          echo "=== Container status ==="
          docker ps -a
          
          echo "=== Backend logs ==="
          docker logs infrastructure-backend-1 || echo "Backend not found"
          
          echo "=== Docker compose ps ==="
          docker compose -f infrastructure/docker-compose.yaml ps

      - name: Check backend logs
        if: always()
        run: |
          echo "=== Backend logs ==="
          docker logs infrastructure-backend-1

      - name: Test backend manually
        run: |
          echo "Testing backend auth..."
          curl -v -X POST http://backend:4111/api/v1/admin/users \
            -H "Authorization: Basic YWRtaW46YWRtaW4=" \
            -H "Content-Type: application/json" \
            -d '{"username":"testUser12","password":"testPass12%"}'

      - name: Run tests
        run: cd infrastructure && bash ./run-tests-with-docker-compose.sh
