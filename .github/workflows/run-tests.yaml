name: Run tests

# Триггер
on: [ push, workflow_dispatch ]

jobs: # аналог этапов
  run-tests:
    name: Set up services (review apps) and run API and UI tests
    runs-on: ubuntu-latest
    steps: # Шаги конкретной job
      - name: Checkout repository # Копируем файлы репо внутрь CI агента
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt
#      - name: Debug - List files
#        run: |
#          echo "Current directory:"
#          pwd
#          echo ""
#          echo "Files in current directory:"
#          ls -la
#          echo ""
#          echo "Files in infrastructure:"
#          ls -la infrastructure/
#          echo ""
#          echo "Files in infrastructure/config:"
#          ls -la infrastructure/config/
#          echo ""
#          echo "Tree structure:"
#          tree -L 3 || find . -maxdepth 3 -print
#          echo "Ищем config.properties:"
#          ls -la resources
      - name: Run containers
        run: cd infrastructure && bash ./restart_docker.sh

      - name: Run API tests
        env:
          SERVER: http://localhost:4111/api
          API_VERSION: /v1
          TEST_PROFILE: api
        run: |
          mkdir -p test-output
          echo ">>> Running API tests"
          pytest -s -v -m api --html=test-output/api-report.html --self-contained-html 2>&1 | tee test-output/api-run.log

      - name: Run UI tests
        env:
          SERVER: http://localhost:4111/api
          API_VERSION: /v1
          UI_REMOTE_URL: http://localhost:4444/wd/hub
          UI_BASE_URL: http://nginx
          TEST_PROFILE: ui
        run: |
          echo ">>> Running UI tests"
          pytest -s -v -m ui --html=test-output/ui-report.html --self-contained-html 2>&1 | tee test-output/ui-run.log

      - name: Stop services
        if: always()
        run: cd infrastructure && docker compose down -v